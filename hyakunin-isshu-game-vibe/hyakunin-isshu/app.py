"""百人一首かるたゲーム - Flask アプリケーション"""

import json
import random
from flask import Flask, render_template, jsonify

app = Flask(__name__)

# 百人一首データ (上の句・下の句)
POEMS = [
    {"id": 1, "kami": "秋の田の かりほの庵の 苫をあらみ", "shimo": "わが衣手は 露にぬれつつ", "author": "天智天皇"},
    {"id": 2, "kami": "春すぎて 夏来にけらし 白妙の", "shimo": "衣ほすてふ 天の香具山", "author": "持統天皇"},
    {"id": 3, "kami": "あしびきの 山鳥の尾の しだり尾の", "shimo": "ながながし夜を ひとりかも寝む", "author": "柿本人麻呂"},
    {"id": 4, "kami": "田子の浦に うち出でてみれば 白妙の", "shimo": "富士の高嶺に 雪は降りつつ", "author": "山部赤人"},
    {"id": 5, "kami": "奥山に 紅葉踏みわけ 鳴く鹿の", "shimo": "声きく時ぞ 秋は悲しき", "author": "猿丸大夫"},
    {"id": 6, "kami": "かささぎの 渡せる橋に おく霜の", "shimo": "白きを見れば 夜ぞふけにける", "author": "中納言家持"},
    {"id": 7, "kami": "天の原 ふりさけ見れば 春日なる", "shimo": "三笠の山に 出でし月かも", "author": "安倍仲麿"},
    {"id": 8, "kami": "わが庵は 都のたつみ しかぞすむ", "shimo": "世をうぢ山と 人はいふなり", "author": "喜撰法師"},
    {"id": 9, "kami": "花の色は うつりにけりな いたづらに", "shimo": "わが身世にふる ながめせしまに", "author": "小野小町"},
    {"id": 10, "kami": "これやこの 行くも帰るも 別れては", "shimo": "知るも知らぬも 逢坂の関", "author": "蝉丸"},
    {"id": 11, "kami": "わたの原 八十島かけて 漕ぎ出でぬと", "shimo": "人には告げよ 海人の釣舟", "author": "参議篁"},
    {"id": 12, "kami": "天つ風 雲の通ひ路 吹きとぢよ", "shimo": "乙女の姿 しばしとどめむ", "author": "僧正遍昭"},
    {"id": 13, "kami": "筑波嶺の 峰より落つる みなの川", "shimo": "恋ぞつもりて 淵となりぬる", "author": "陽成院"},
    {"id": 14, "kami": "陸奥の しのぶもぢずり 誰ゆゑに", "shimo": "乱れそめにし われならなくに", "author": "河原左大臣"},
    {"id": 15, "kami": "君がため 春の野に出でて 若菜つむ", "shimo": "わが衣手に 雪は降りつつ", "author": "光孝天皇"},
    {"id": 16, "kami": "立ち別れ いなばの山の 峰に生ふる", "shimo": "まつとし聞かば 今帰り来む", "author": "中納言行平"},
    {"id": 17, "kami": "ちはやぶる 神代もきかず 竜田川", "shimo": "からくれなゐに 水くくるとは", "author": "在原業平朝臣"},
    {"id": 18, "kami": "住の江の 岸による波 よるさへや", "shimo": "夢の通ひ路 人目よくらむ", "author": "藤原敏行朝臣"},
    {"id": 19, "kami": "難波潟 みじかき芦の ふしの間も", "shimo": "逢はでこの世を 過ぐしてよとや", "author": "伊勢"},
    {"id": 20, "kami": "わびぬれば 今はた同じ 難波なる", "shimo": "みをつくしても 逢はむとぞ思ふ", "author": "元良親王"},
    {"id": 21, "kami": "今来むと いひしばかりに 長月の", "shimo": "有明の月を 待ち出でつるかな", "author": "素性法師"},
    {"id": 22, "kami": "吹くからに 秋の草木の しをるれば", "shimo": "むべ山風を 嵐といふらむ", "author": "文屋康秀"},
    {"id": 23, "kami": "月見れば ちぢにものこそ 悲しけれ", "shimo": "わが身ひとつの 秋にはあらねど", "author": "大江千里"},
    {"id": 24, "kami": "このたびは ぬさもとりあへず 手向山", "shimo": "紅葉の錦 神のまにまに", "author": "菅家"},
    {"id": 25, "kami": "名にし負はば 逢坂山の さねかづら", "shimo": "人に知られで くるよしもがな", "author": "三条右大臣"},
    {"id": 26, "kami": "小倉山 峰のもみぢ葉 心あらば", "shimo": "今ひとたびの みゆき待たなむ", "author": "貞信公"},
    {"id": 27, "kami": "みかの原 わきて流るる いづみ川", "shimo": "いつ見きとてか 恋しかるらむ", "author": "中納言兼輔"},
    {"id": 28, "kami": "山里は 冬ぞさびしさ まさりける", "shimo": "人目も草も かれぬと思へば", "author": "源宗于朝臣"},
    {"id": 29, "kami": "心あてに 折らばや折らむ 初霜の", "shimo": "おきまどはせる 白菊の花", "author": "凡河内躬恒"},
    {"id": 30, "kami": "有明の つれなく見えし 別れより", "shimo": "暁ばかり 憂きものはなし", "author": "壬生忠岑"},
    {"id": 31, "kami": "朝ぼらけ 有明の月と 見るまでに", "shimo": "吉野の里に 降れる白雪", "author": "坂上是則"},
    {"id": 32, "kami": "山川に 風のかけたる しがらみは", "shimo": "流れもあへぬ 紅葉なりけり", "author": "春道列樹"},
    {"id": 33, "kami": "ひさかたの 光のどけき 春の日に", "shimo": "しづ心なく 花の散るらむ", "author": "紀友則"},
    {"id": 34, "kami": "誰をかも 知る人にせむ 高砂の", "shimo": "松も昔の 友ならなくに", "author": "藤原興風"},
    {"id": 35, "kami": "人はいさ 心も知らず ふるさとは", "shimo": "花ぞ昔の 香ににほひける", "author": "紀貫之"},
    {"id": 36, "kami": "夏の夜は まだ宵ながら 明けぬるを", "shimo": "雲のいづこに 月宿るらむ", "author": "清原深養父"},
    {"id": 37, "kami": "白露に 風の吹きしく 秋の野は", "shimo": "つらぬきとめぬ 玉ぞ散りける", "author": "文屋朝康"},
    {"id": 38, "kami": "忘らるる 身をば思はず 誓ひてし", "shimo": "人の命の 惜しくもあるかな", "author": "右近"},
    {"id": 39, "kami": "浅茅生の 小野の篠原 しのぶれど", "shimo": "あまりてなどか 人の恋しき", "author": "参議等"},
    {"id": 40, "kami": "しのぶれど 色に出でにけり わが恋は", "shimo": "ものや思ふと 人の問ふまで", "author": "平兼盛"},
    {"id": 41, "kami": "恋すてふ わが名はまだき 立ちにけり", "shimo": "人知れずこそ 思ひそめしか", "author": "壬生忠見"},
    {"id": 42, "kami": "契りきな かたみに袖を しぼりつつ", "shimo": "末の松山 波こさじとは", "author": "清原元輔"},
    {"id": 43, "kami": "逢ひ見ての のちの心に くらぶれば", "shimo": "昔はものを 思はざりけり", "author": "権中納言敦忠"},
    {"id": 44, "kami": "逢ふことの 絶えてしなくは なかなかに", "shimo": "人をも身をも 恨みざらまし", "author": "中納言朝忠"},
    {"id": 45, "kami": "あはれとも いふべき人は 思ほえで", "shimo": "身のいたづらに なりぬべきかな", "author": "謙徳公"},
    {"id": 46, "kami": "由良の門を 渡る舟人 かぢを絶え", "shimo": "ゆくへも知らぬ 恋の道かな", "author": "曾禰好忠"},
    {"id": 47, "kami": "八重むぐら しげれる宿の さびしきに", "shimo": "人こそ見えね 秋は来にけり", "author": "恵慶法師"},
    {"id": 48, "kami": "風をいたみ 岩うつ波の おのれのみ", "shimo": "くだけて物を 思ふころかな", "author": "源重之"},
    {"id": 49, "kami": "みかきもり 衛士のたく火の 夜は燃え", "shimo": "昼は消えつつ 物をこそ思へ", "author": "大中臣能宣朝臣"},
    {"id": 50, "kami": "君がため 惜しからざりし 命さへ", "shimo": "長くもがなと 思ひけるかな", "author": "藤原義孝"},
    {"id": 51, "kami": "かくとだに えやはいぶきの さしも草", "shimo": "さしも知らじな 燃ゆる思ひを", "author": "藤原実方朝臣"},
    {"id": 52, "kami": "明けぬれば 暮るるものとは 知りながら", "shimo": "なほ恨めしき 朝ぼらけかな", "author": "藤原道信朝臣"},
    {"id": 53, "kami": "嘆きつつ ひとり寝る夜の 明くる間は", "shimo": "いかに久しき ものとかは知る", "author": "右大将道綱母"},
    {"id": 54, "kami": "忘れじの 行く末までは かたければ", "shimo": "今日を限りの 命ともがな", "author": "儀同三司母"},
    {"id": 55, "kami": "滝の音は 絶えて久しく なりぬれど", "shimo": "名こそ流れて なほ聞こえけれ", "author": "大納言公任"},
    {"id": 56, "kami": "あらざらむ この世のほかの 思ひ出に", "shimo": "今ひとたびの 逢ふこともがな", "author": "和泉式部"},
    {"id": 57, "kami": "めぐり逢ひて 見しやそれとも わかぬ間に", "shimo": "雲がくれにし 夜半の月かな", "author": "紫式部"},
    {"id": 58, "kami": "有馬山 猪名の笹原 風吹けば", "shimo": "いでそよ人を 忘れやはする", "author": "大弐三位"},
    {"id": 59, "kami": "やすらはで 寝なましものを さ夜更けて", "shimo": "かたぶくまでの 月を見しかな", "author": "赤染衛門"},
    {"id": 60, "kami": "大江山 いく野の道の 遠ければ", "shimo": "まだふみもみず 天の橋立", "author": "小式部内侍"},
    {"id": 61, "kami": "いにしへの 奈良の都の 八重桜", "shimo": "けふ九重に にほひぬるかな", "author": "伊勢大輔"},
    {"id": 62, "kami": "夜をこめて 鳥のそら音は はかるとも", "shimo": "よに逢坂の 関はゆるさじ", "author": "清少納言"},
    {"id": 63, "kami": "今はただ 思ひ絶えなむ とばかりを", "shimo": "人づてならで いふよしもがな", "author": "左京大夫道雅"},
    {"id": 64, "kami": "朝ぼらけ 宇治の川霧 たえだえに", "shimo": "あらはれわたる 瀬々の網代木", "author": "権中納言定頼"},
    {"id": 65, "kami": "恨みわび ほさぬ袖だに あるものを", "shimo": "恋に朽ちなむ 名こそ惜しけれ", "author": "相模"},
    {"id": 66, "kami": "もろともに あはれと思へ 山桜", "shimo": "花よりほかに 知る人もなし", "author": "前大僧正行尊"},
    {"id": 67, "kami": "春の夜の 夢ばかりなる 手枕に", "shimo": "かひなく立たむ 名こそ惜しけれ", "author": "周防内侍"},
    {"id": 68, "kami": "心にも あらでうき世に ながらへば", "shimo": "恋しかるべき 夜半の月かな", "author": "三条院"},
    {"id": 69, "kami": "嵐吹く 三室の山の もみぢ葉は", "shimo": "竜田の川の 錦なりけり", "author": "能因法師"},
    {"id": 70, "kami": "さびしさに 宿を立ち出でて ながむれば", "shimo": "いづこも同じ 秋の夕暮れ", "author": "良暹法師"},
    {"id": 71, "kami": "夕されば 門田の稲葉 おとづれて", "shimo": "芦のまろ屋に 秋風ぞ吹く", "author": "大納言経信"},
    {"id": 72, "kami": "音に聞く 高師の浜の あだ波は", "shimo": "かけじや袖の ぬれもこそすれ", "author": "祐子内親王家紀伊"},
    {"id": 73, "kami": "高砂の 尾の上の桜 咲きにけり", "shimo": "外山の霞 立たずもあらなむ", "author": "権中納言匡房"},
    {"id": 74, "kami": "憂かりける 人を初瀬の 山おろしよ", "shimo": "はげしかれとは 祈らぬものを", "author": "源俊頼朝臣"},
    {"id": 75, "kami": "契りおきし させもが露を 命にて", "shimo": "あはれ今年の 秋もいぬめり", "author": "藤原基俊"},
    {"id": 76, "kami": "わたの原 漕ぎ出でて見れば ひさかたの", "shimo": "雲居にまがふ 沖つ白波", "author": "法性寺入道前関白太政大臣"},
    {"id": 77, "kami": "瀬をはやみ 岩にせかるる 滝川の", "shimo": "われても末に 逢はむとぞ思ふ", "author": "崇徳院"},
    {"id": 78, "kami": "淡路島 通ふ千鳥の 鳴く声に", "shimo": "いく夜寝覚めぬ 須磨の関守", "author": "源兼昌"},
    {"id": 79, "kami": "秋風に たなびく雲の 絶え間より", "shimo": "もれ出づる月の 影のさやけさ", "author": "左京大夫顕輔"},
    {"id": 80, "kami": "ながからむ 心も知らず 黒髪の", "shimo": "乱れてけさは 物をこそ思へ", "author": "待賢門院堀河"},
    {"id": 81, "kami": "ほととぎす 鳴きつる方を ながむれば", "shimo": "ただ有明の 月ぞ残れる", "author": "後徳大寺左大臣"},
    {"id": 82, "kami": "思ひわび さても命は あるものを", "shimo": "憂きに堪へぬは 涙なりけり", "author": "道因法師"},
    {"id": 83, "kami": "世の中よ 道こそなけれ 思ひ入る", "shimo": "山の奥にも 鹿ぞ鳴くなる", "author": "皇太后宮大夫俊成"},
    {"id": 84, "kami": "ながらへば またこのごろや しのばれむ", "shimo": "憂しと見し世ぞ 今は恋しき", "author": "藤原清輔朝臣"},
    {"id": 85, "kami": "夜もすがら 物思ふころは 明けやらで", "shimo": "閨のひまさへ つれなかりけり", "author": "俊恵法師"},
    {"id": 86, "kami": "嘆けとて 月やは物を 思はする", "shimo": "かこち顔なる わが涙かな", "author": "西行法師"},
    {"id": 87, "kami": "村雨の 露もまだ干ぬ まきの葉に", "shimo": "霧立ちのぼる 秋の夕暮れ", "author": "寂蓮法師"},
    {"id": 88, "kami": "難波江の 芦のかりねの ひとよゆゑ", "shimo": "みをつくしてや 恋ひわたるべき", "author": "皇嘉門院別当"},
    {"id": 89, "kami": "玉の緒よ 絶えなば絶えね ながらへば", "shimo": "忍ぶることの 弱りもぞする", "author": "式子内親王"},
    {"id": 90, "kami": "見せばやな 雄島の海人の 袖だにも", "shimo": "ぬれにぞぬれし 色はかはらず", "author": "殷富門院大輔"},
    {"id": 91, "kami": "きりぎりす 鳴くや霜夜の さむしろに", "shimo": "衣かたしき ひとりかも寝む", "author": "後京極摂政前太政大臣"},
    {"id": 92, "kami": "わが袖は 潮干に見えぬ 沖の石の", "shimo": "人こそ知らね 乾く間もなし", "author": "二条院讃岐"},
    {"id": 93, "kami": "世の中は 常にもがもな 渚漕ぐ", "shimo": "海人の小舟の 綱手かなしも", "author": "鎌倉右大臣"},
    {"id": 94, "kami": "み吉野の 山の秋風 さ夜更けて", "shimo": "ふるさと寒く 衣うつなり", "author": "参議雅経"},
    {"id": 95, "kami": "おほけなく うき世の民に おほふかな", "shimo": "わが立つ杣に 墨染の袖", "author": "前大僧正慈円"},
    {"id": 96, "kami": "花さそふ 嵐の庭の 雪ならで", "shimo": "ふりゆくものは わが身なりけり", "author": "入道前太政大臣"},
    {"id": 97, "kami": "来ぬ人を まつほの浦の 夕なぎに", "shimo": "焼くや藻塩の 身もこがれつつ", "author": "権中納言定家"},
    {"id": 98, "kami": "風そよぐ ならの小川の 夕暮れは", "shimo": "みそぎぞ夏の しるしなりける", "author": "従二位家隆"},
    {"id": 99, "kami": "人も愛し 人も恨めし あぢきなく", "shimo": "世を思ふゆゑに 物思ふ身は", "author": "後鳥羽院"},
    {"id": 100, "kami": "ももしきや 古き軒端の しのぶにも", "shimo": "なほあまりある 昔なりけり", "author": "順徳院"},
]


@app.route("/")
def index():
    return render_template("index.html")


@app.route("/api/start", methods=["POST"])
def start_game():
    """ゲーム開始: シャッフルした100首の順番を返す"""
    order = list(range(100))
    random.shuffle(order)
    return jsonify({"order": order})


@app.route("/api/question/<int:idx>")
def get_question(idx):
    """指定インデックスの問題を返す (上の句 + 選択肢4つの下の句)"""
    poem = POEMS[idx]
    # 正解を含む4つの選択肢を作成
    wrong_pool = [p for p in POEMS if p["id"] != poem["id"]]
    wrongs = random.sample(wrong_pool, 3)
    choices = [{"shimo": poem["shimo"], "id": poem["id"]}]
    for w in wrongs:
        choices.append({"shimo": w["shimo"], "id": w["id"]})
    random.shuffle(choices)
    return jsonify({
        "kami": poem["kami"],
        "author": poem["author"],
        "correct_id": poem["id"],
        "choices": choices,
    })


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
